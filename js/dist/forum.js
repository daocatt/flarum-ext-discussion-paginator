(()=>{var t={n:e=>{var s=e&&e.__esModule?()=>e.default:()=>e;return t.d(s,{a:s}),s},d:(e,s)=>{for(var o in s)t.o(s,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:s[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e);const s=flarum.core.compat["forum/app"];var o=t.n(s);const n=flarum.core.compat.extend,a=flarum.core.compat["common/utils/ItemList"];var r=t.n(a);const i=flarum.core.compat["forum/components/DiscussionPage"];var c=t.n(i);const u=flarum.core.compat["forum/components/DiscussionListItem"];var p=t.n(u);function d(t,e){return d=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},d(t,e)}function l(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,d(t,e)}const h=flarum.core.compat["common/Component"];var g=t.n(h);const f=flarum.core.compat["common/components/LoadingPost"];var y=t.n(f);const v=flarum.core.compat["common/components/ReplyPlaceholder"];var P=t.n(v);const b=flarum.core.compat["common/helpers/listItems"];var C=t.n(b),I=function(t){function e(){return t.apply(this,arguments)||this}l(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.stream=this.attrs.stream,this.perPage=20,this.perBlock=5,this.listCount=parseInt(this.attrs.listCount),this.pageCurrent=parseInt(this.attrs.pageCurrent),this.pageCount=Math.ceil(this.listCount/this.perPage)},s.oncreate=function(e){t.prototype.oncreate.call(this,e)},s.onupdate=function(e){t.prototype.onupdate.call(this,e)},s.view=function(){return this.listCount<=20?"":m("div",{className:"Paginator"},m("div",{className:"container"},m("ul",{className:"Paginator-items"},C()(this.items().toArray()))))},s.items=function(){var t=new(r()),e=this.pageCurrent,s=this.pageCount;e=e>s?s:e,t.add("firstPage",m("span",{classname:1==e&&"current",onclick:this.goToFirst.bind(this)},"<"));var o,n=Math.floor(e/this.perBlock);e===this.perBlock*n&&n--;var a=n*this.perBlock+1,i=(n+1)*this.perBlock>s?s:(n+1)*this.perBlock;(s-e<5||s<11)&&(i=s),i-a<4&&(a-=5-(i-a)),a<=5&&(a=1),e>5&&s>10&&t.add("prevPage",m("span",{className:"prev",onclick:this.goToPage.bind(this,a-1)},"..."));var c=0;for(o=a;o<=i;o++)c=o,t.add(e==o?"pageItem current pageItem-"+o:"pageItem pageItem-"+o,m("span",{className:"item",onclick:this.goToPage.bind(this,c)},o));return s-e>5&&s>10&&t.add("nextPage",m("span",{className:"next",onclick:this.goToPage.bind(this,i+1)},"...")),t.add("lastPage",m("span",{className:e==s&&"current",onclick:this.goToLast.bind(this)},">")),t},s.syncPromise=function(){var t=this,e=$("html, body").stop(!0);return Promise.all([e.promise(),this.stream.loadPromise]).then((function(){m.redraw.sync(),t.stream.paused=!1}))},s.goToLast=function(){return this.goToPage(this.pageCount)},s.goToFirst=function(){this.pageCurrent=1,this.stream.goToFirst(),this.syncPromise()},s.goToPage=function(t){if(1===(t=parseInt(t)))return this.goToFirst();this.pageCurrent=t;var e=(t-1)*this.perPage+this.perPage/2;this.stream.goToIndex(e),this.syncPromise(),this.attrs.onPageChange(this.pageCurrent)},e}(g()),T=function(t){function e(){return t.apply(this,arguments)||this}l(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.discussion=this.attrs.discussion,this.stream=this.attrs.stream},s.view=function(){var t,e=this,s=this.stream.posts(),n=this.discussion.postIds(),a=function(t){$(t.dom).addClass("fadeIn"),setTimeout((function(){return $(t.dom).removeClass("fadeIn")}),500)},r=s.map((function(s,r){var i,c={"data-index":e.stream.visibleStart+r};if(s){var u=s.createdAt(),p=o().postComponents[s.contentType()];i=!!p&&m(p,{post:s}),c.key="post"+s.id(),c.oncreate=a,c["data-time"]=u.toISOString(),c["data-number"]=s.number(),c["data-id"]=s.id(),c["data-type"]=s.contentType();var d=u-t;d>3456e5&&(i=[m("div",{className:"PostStream-timeGap"},m("span",null,o().translator.trans("core.forum.post_stream.time_lapsed_text",{period:dayjs().add(d,"ms").fromNow(!0)}))),i]),t=u}else c.key="post"+n[e.stream.visibleStart+r],i=m(y(),null);return m("div",Object.assign({className:"PostStream-item"},c),i)}));return r.push(m("div",{className:"PostStream-pagination",key:"pagination"},m(I,{listCount:this.stream.discussion.attribute("commentCount"),stream:this.stream,onPageChange:this.attrs.onPageChange,pageCurrent:"1"}))),r.push.apply(r,this.endItems().toArray()),o().session.user&&!this.discussion.canReply()||r.push(m("div",{className:"PostStream-item",key:"reply","data-index":this.stream.count(),oncreate:a},m(P(),{discussion:this.discussion}))),m("div",{className:"PostStream",role:"feed","aria-live":"off","aria-busy":this.stream.pagesLoading?"true":"false"},r)},s.endItems=function(){return new(r())},s.onupdate=function(e){t.prototype.onupdate.call(this,e)},s.oncreate=function(e){t.prototype.oncreate.call(this,e)},e}(g());o().initializers.add("gtdxyz-discussion-paginator",(function(){(0,n.override)(p().prototype,"getJumpTo",(function(){return 0})),(0,n.extend)(c().prototype,"sidebarItems",(function(t){t.remove("scrubber")})),(0,n.override)(c().prototype,"view",(function(t){return this.pageChanged=function(t){var e=this.discussion;if(e){var s=o().route.discussion(e,this.near=t);window.history.replaceState(null,document.title,s),o().history.push("discussion",e.title())}},this.mainContent=function(){var t=new(r());return t.add("sidebar",this.sidebar(),100),t.add("poststream",m("div",{className:"DiscussionPage-stream"},m(T,{discussion:this.discussion,stream:this.stream,onPageChange:this.pageChanged.bind(this)})),10),t},t()}))}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map