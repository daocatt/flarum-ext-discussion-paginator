(()=>{var t={n:e=>{var s=e&&e.__esModule?()=>e.default:()=>e;return t.d(s,{a:s}),s},d:(e,s)=>{for(var o in s)t.o(s,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:s[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e);const s=flarum.core.compat["forum/app"];var o=t.n(s);const r=flarum.core.compat.extend,n=flarum.core.compat["common/utils/ItemList"];var i=t.n(n);const a=flarum.core.compat["forum/states/PostStreamState"];var c=t.n(a);const u=flarum.core.compat["forum/components/DiscussionPage"];var p=t.n(u);const d=flarum.core.compat["forum/components/DiscussionListItem"];var l=t.n(d);function h(t,e){return h=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},h(t,e)}function f(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,h(t,e)}const g=flarum.core.compat["common/Component"];var y=t.n(g);const v=flarum.core.compat["common/components/LoadingPost"];var P=t.n(v);const b=flarum.core.compat["common/components/ReplyPlaceholder"];var C=t.n(b);const T=flarum.core.compat["common/helpers/listItems"];var I=t.n(T),S=function(t){function e(){return t.apply(this,arguments)||this}f(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.stream=this.attrs.stream,this.perPage=20,this.perBlock=5,this.listCount=parseInt(this.attrs.listCount),this.pageCurrent=parseInt(this.attrs.pageCurrent),this.pageCount=Math.ceil(this.listCount/this.perPage)},s.oncreate=function(e){t.prototype.oncreate.call(this,e)},s.onupdate=function(e){t.prototype.onupdate.call(this,e)},s.view=function(){return this.listCount<=20?"":m("div",{className:"Paginator"},m("div",{className:"container"},m("ul",{className:"Paginator-items"},I()(this.items().toArray()))))},s.items=function(){var t=new(i()),e=this.pageCurrent,s=this.pageCount;e=e>s?s:e,t.add("firstPage",m("span",{classname:1==e&&"current",onclick:this.goToFirst.bind(this)},"<"));var o,r=Math.floor(e/this.perBlock);e===this.perBlock*r&&r--;var n=r*this.perBlock+1,a=(r+1)*this.perBlock>s?s:(r+1)*this.perBlock;(s-e<5||s<11)&&(a=s),a-n<4&&(n-=5-(a-n)),n<=5&&(n=1),e>5&&s>10&&t.add("prevPage",m("span",{className:"prev",onclick:this.goToPage.bind(this,n-1)},"..."));var c=0;for(o=n;o<=a;o++)c=o,t.add(e==o?"pageItem current pageItem-"+o:"pageItem pageItem-"+o,m("span",{className:"item",onclick:this.goToPage.bind(this,c)},o));return s-e>5&&s>10&&t.add("nextPage",m("span",{className:"next",onclick:this.goToPage.bind(this,a+1)},"...")),t.add("lastPage",m("span",{className:e==s&&"current",onclick:this.goToLast.bind(this)},">")),t},s.syncPromise=function(){var t=this,e=$("html, body").stop(!0);return Promise.all([e.promise(),this.stream.loadPromise]).then((function(){m.redraw.sync(),t.stream.paused=!1}))},s.goToLast=function(){return this.goToPage(this.pageCount)},s.goToFirst=function(){this.pageCurrent=1,this.stream.goToFirst(),this.syncPromise()},s.goToPage=function(t){if(1===(t=parseInt(t)))return this.goToFirst();this.pageCurrent=t;var e=(t-1)*this.perPage+this.perPage/2;this.stream.goToIndex(e),this.syncPromise(),this.attrs.onPageChange(this.pageCurrent)},e}(y()),k=function(t){function e(){return t.apply(this,arguments)||this}f(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.discussion=this.attrs.discussion,this.stream=this.attrs.stream,this.pageCurrent=Math.round(this.stream.visibleStart/20)+1},s.view=function(){var t,e=this,s=this.stream.posts(),r=this.discussion.postIds(),n=function(t){$(t.dom).addClass("fadeIn"),setTimeout((function(){return $(t.dom).removeClass("fadeIn")}),500)},i=s.map((function(s,i){var a,c={"data-index":e.stream.visibleStart+i};if(s){var u=s.createdAt(),p=o().postComponents[s.contentType()];a=!!p&&m(p,{post:s}),c.key="post"+s.id(),c.oncreate=n,c["data-time"]=u.toISOString(),c["data-number"]=s.number(),c["data-id"]=s.id(),c["data-type"]=s.contentType();var d=u-t;d>3456e5&&(a=[m("div",{className:"PostStream-timeGap"},m("span",null,o().translator.trans("core.forum.post_stream.time_lapsed_text",{period:dayjs().add(d,"ms").fromNow(!0)}))),a]),t=u}else c.key="post"+r[e.stream.visibleStart+i],a=m(P(),null);return m("div",Object.assign({className:"PostStream-item"},c),a)}));return i.push(m("div",{className:"PostStream-pagination",key:"pagination"},m(S,{listCount:this.stream.discussion.attribute("commentCount"),stream:this.stream,onPageChange:this.attrs.onPageChange,pageCurrent:this.pageCurrent}))),i.push.apply(i,this.endItems().toArray()),o().session.user&&!this.discussion.canReply()||i.push(m("div",{className:"PostStream-item",key:"reply","data-index":this.stream.count(),oncreate:n},m(C(),{discussion:this.discussion}))),m("div",{className:"PostStream",role:"feed","aria-live":"off","aria-busy":this.stream.pagesLoading?"true":"false"},i)},s.endItems=function(){return new(i())},s.onupdate=function(e){t.prototype.onupdate.call(this,e)},s.oncreate=function(e){t.prototype.oncreate.call(this,e)},e}(y());o().initializers.add("gtdxyz-discussion-paginator",(function(){(0,r.override)(l().prototype,"getJumpTo",(function(){return 0})),(0,r.extend)(p().prototype,"sidebarItems",(function(t){t.remove("scrubber")})),(0,r.override)(p().prototype,"show",(function(t,e){var s,r,n=this;o().history.push("discussion",e.title()),o().setTitle(e.title()),o().setTitleCount(0);var i=[];if(e.payload&&e.payload.included){var a=e.id();i=e.payload.included.filter((function(t){return"posts"===t.type&&t.relationships&&t.relationships.discussion&&!Array.isArray(t.relationships.discussion.data)&&t.relationships.discussion.data.id===a})).map((function(t){return o().store.getById("posts",t.id)})).sort((function(t,e){return t.number()-e.number()})).slice(0,20)}this.stream=new(c())(e,i);var u,p=m.route.param("near"),d="reply"===p?"reply":parseInt(p);u="reply"===d?d:20*(d-1)+1+10,this.stream.goToNumber(u||(null!=(s=null==(r=i[0])?void 0:r.number())?s:0),!0).then((function(){n.discussion=e,o().current.set("discussion",e),o().current.set("stream",n.stream)}))})),(0,r.override)(p().prototype,"view",(function(t){return this.pageChanged=function(t){var e=this.discussion;if(e){var s=o().route.discussion(e,this.near=t);window.history.replaceState(null,document.title,s),o().history.push("discussion",e.title())}},this.mainContent=function(){var t=new(i());return t.add("sidebar",this.sidebar(),100),t.add("poststream",m("div",{className:"DiscussionPage-stream"},m(k,{discussion:this.discussion,stream:this.stream,onPageChange:this.pageChanged.bind(this)})),10),t},t()}))}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map